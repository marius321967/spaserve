#!/usr/bin/env node

const argv = require('minimist')(process.argv.slice(2));
const path = require('path');
const fs = require('fs');
const express = require('express');
const dir = argv.dir || process.env.DIR || 'dist';
const notfoundroute = argv.notfoundroute || process.env.NOTFOUNDROUTE || '404';
const port = argv.port || process.env.PORT || 5000;
const https = argv.https || process.env.HTTPS || false;
const sslkey = argv.sslkey || process.env.SSLKEY || 'ssl/key.pem';
const sslcert = argv.sslcert || process.env.SSLCERT || 'ssl/cert.pem';
const sslpassphrase = argv.sslpassphrase || process.env.SSLPASSPHRASE;

// Validate https arguments
if (https) {
    if (!sslkey || !sslcert) return console.error('HTTPS is enabled but --ssl* arguments are empty');
    if (!fs.existsSync(sslkey)) return console.error('SSL key not found at ' + sslkey);
    if (!fs.existsSync(sslcert)) return console.error('SSL certificate not found at ' + sslcert);
}

const app = express();
app.use(express.static(dir));

// Handle 404s for SPA
app.use((req, res) => { // This middlware is called when express.static does not find the file
    if (req.path == '/' + notfoundroute) res.status(404);
    
    res.sendFile(path.resolve(dir + '/index.html'));
})

console.log('Listening on port ' + port);
if (https) {
    const opts = { 
        key: fs.readFileSync(sslkey).toString(), 
        cert: fs.readFileSync(sslcert).toString(), 
        passphrase: sslpassphrase 
    };
    require('https').createServer(opts, app).listen(port);
}
else
    app.listen(port);